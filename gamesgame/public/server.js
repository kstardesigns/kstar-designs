require("dotenv").config();const express=require("express"),fetch=require("node-fetch"),path=require("path"),app=express(),clientId=process.env.CLIENT_ID,clientSecret=process.env.CLIENT_SECRET;let accessToken="";async function getAccessToken(){try{const e=await fetch("https://id.twitch.tv/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:clientId,client_secret:clientSecret,grant_type:"client_credentials"})}),t=await e.json();accessToken=t.access_token,console.log("Access token obtained:",accessToken)}catch(e){console.error("Error obtaining access token:",e)}}async function fetchData(e){try{console.log("Sending request with query:",e),console.log("access:"+accessToken);const t=await fetch("https://api.igdb.com/v4/games",{method:"POST",headers:{"Client-ID":clientId,Authorization:`Bearer ${accessToken}`,Accept:"application/json"},body:e}),a=await t.json();return console.log("Raw response data:",a),a}catch(e){throw console.error("Error fetching data from IGDB:",e),e}}async function fetchAgeRatings(e){try{const t=`fields rating, content_descriptions; where id = (${e.join(",")});`;console.log("Age Ratings Query:",t);const a=await fetch("https://api.igdb.com/v4/age_ratings",{method:"POST",headers:{"Client-ID":clientId,Authorization:`Bearer ${accessToken}`,Accept:"application/json"},body:t}),o=await a.json();return console.log("Age Ratings Data:",o),o}catch(e){throw console.error("Error fetching age ratings from IGDB:",e),e}}async function fetchInvolvedCompanies(e){try{const t=`fields company.*; where id = (${e.join(",")});`;console.log("Company list Query:",t);const a=await fetch("https://api.igdb.com/v4/involved_companies",{method:"POST",headers:{"Client-ID":clientId,Authorization:`Bearer ${accessToken}`,Accept:"application/json"},body:t}),o=await a.json();return console.log("Involved companies Data:",o),o}catch(e){throw console.error("Error fetching age ratings from IGDB:",e),e}}async function fetchCharacters(e){try{const t=`fields id, name, akas; where ${e.map((e=>`name ~ *"${e}"*`)).join(" | ")};`;console.log("Character query:",t);const a=await fetch("https://api.igdb.com/v4/characters",{method:"POST",headers:{"Client-ID":clientId,Authorization:`Bearer ${accessToken}`,Accept:"application/json"},body:t});if(!a.ok)throw new Error(`HTTP error! Status: ${a.status}`);const o=await a.json();return console.log("characters:",o),o}catch(e){throw console.error("Error fetching characters from IGDB:",e),e}}app.use(express.static(path.join(__dirname,"public"))),app.get("/games",(async(e,t)=>{accessToken||await getAccessToken();const a=e.query.search;try{const e=`search "${a}"; where rating > 1; fields name, cover.url, release_dates.date; limit 10;`,o=await fetchData(e);t.json(o)}catch(e){t.status(500).json({error:"Failed to fetch data from IGDB"})}})),app.get("/game",(async(e,t)=>{accessToken||await getAccessToken();const a=e.query.id;try{const e=`where id = ${a}; fields *, cover.url, release_dates.y, age_ratings.content_descriptions, involved_companies.*;`,o=await fetchData(e);t.json(o)}catch(e){t.status(500).json({error:"Failed to fetch data from IGDB"})}})),app.get("/age_ratings",(async(e,t)=>{accessToken||await getAccessToken();const a=e.query.ids.split(",").map((e=>parseInt(e,10)));console.log("Rating IDs from Request:",a);try{const e=await fetchAgeRatings(a);t.json(e)}catch(e){t.status(500).json({error:"Failed to fetch data from IGDB"})}})),app.get("/involved_companies",(async(e,t)=>{accessToken||await getAccessToken();const a=e.query.ids.split(",").map((e=>parseInt(e,10)));console.log("Company IDs from Request:",a);try{const e=await fetchInvolvedCompanies(a);t.json(e)}catch(e){t.status(500).json({error:"Failed to fetch data from IGDB"})}})),app.get("/characters",(async(e,t)=>{accessToken||await getAccessToken();const a=e.query.searchTerms.split(",");console.log("Search Terms from Request:",a);try{const e=await fetchCharacters(a);t.json(e)}catch(e){t.status(500).json({error:"Failed to fetch data from IGDB"})}})),app.get("*",((e,t)=>{t.sendFile(path.join(__dirname,"public","index.html"))})),app.listen(3e3,(()=>{console.log("Server is running on port 3000")}));